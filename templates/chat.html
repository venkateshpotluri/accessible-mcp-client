{% extends "base.html" %}

{% block title %}Chat - Accessible MCP Client{% endblock %}

{% block page_title %}
<header class="page-header">
    <h1 class="page-title">Chat with MCP Servers</h1>
    <p class="page-description">
        Interact with your connected MCP servers using natural language through Claude AI.
    </p>
</header>
{% endblock %}

{% block content %}
<div class="chat-interface">
    <!-- Session Management -->
    <section class="chat-sidebar" aria-labelledby="sessions-heading">
        <div class="sidebar-header">
            <h2 id="sessions-heading" class="sidebar-title">
                <span class="section-icon" aria-hidden="true">üí¨</span>
                Chat Sessions
            </h2>
            <button type="button" id="new-session-btn" class="btn btn--primary btn--small">
                <span class="btn__icon" aria-hidden="true">‚ûï</span>
                New Chat
            </button>
        </div>
        
        <div id="sessions-list" class="sessions-list" role="list" aria-live="polite">
            <div class="loading-placeholder">Loading sessions...</div>
        </div>
        
        <!-- Server Selection -->
        <div class="server-selection">
            <h3 class="server-selection__title">Active MCP Servers</h3>
            <div id="server-checkboxes" class="server-checkboxes">
                <!-- Will be populated dynamically -->
            </div>
            <div class="form-help">
                Select which MCP servers Claude can use in this conversation.
            </div>
        </div>
    </section>
    
    <!-- Chat Area -->
    <main class="chat-main" aria-labelledby="chat-heading">
        <header class="chat-head">
            <h2 id="chat-heading" class="chat-title">
                <span id="current-session-title">Select or create a chat session</span>
            </h2>
            <div class="chat-controls">
                <button type="button" id="clear-chat-btn" class="btn btn--secondary btn--small" disabled>
                    <span class="btn__icon" aria-hidden="true">üóëÔ∏è</span>
                    Clear Chat
                </button>
                <button type="button" id="export-chat-btn" class="btn btn--secondary btn--small" disabled>
                    <span class="btn__icon" aria-hidden="true">üíæ</span>
                    Export
                </button>
            </div>
        </header>
        
        <div id="chat-messages" class="chat-messages" role="log" aria-live="polite" aria-label="Chat conversation">
            <div class="chat-welcome">
                <div class="welcome-message">
                    <h3>Welcome to MCP Chat!</h3>
                    <p>Start a conversation by creating a new chat session and selecting your MCP servers.</p>
                    <ul class="welcome-tips">
                        <li>Select which MCP servers you want Claude to have access to</li>
                        <li>Ask Claude to use tools from your connected servers</li>
                        <li>Get help with tasks using natural language</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <form id="chat-form" class="chat-input-form" aria-label="Send message form">
            <div class="input-group">
                <label for="message-input" class="sr-only">Type your message</label>
                <textarea 
                    id="message-input" 
                    name="message" 
                    class="chat-input" 
                    placeholder="Type your message here... (Shift+Enter for new line)"
                    rows="3"
                    disabled
                    aria-describedby="input-help"
                ></textarea>
                <div id="input-help" class="form-help">
                    Press Enter to send, Shift+Enter for new line. Claude can use tools from your selected MCP servers.
                </div>
            </div>
            <div class="input-actions">
                <button type="submit" id="send-btn" class="btn btn--primary" disabled>
                    <span class="btn__icon" aria-hidden="true">üöÄ</span>
                    Send Message
                </button>
                <button type="button" id="stop-btn" class="btn btn--secondary" style="display: none;">
                    <span class="btn__icon" aria-hidden="true">‚èπÔ∏è</span>
                    Stop
                </button>
            </div>
        </form>
    </main>
</div>

<!-- New Session Modal -->
<div id="new-session-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="new-session-title" aria-hidden="true">
    <div class="modal__overlay" aria-hidden="true"></div>
    <div class="modal__container">
        <header class="modal__header">
            <h2 id="new-session-title" class="modal__title">Create New Chat Session</h2>
            <button type="button" class="modal__close" aria-label="Close modal" data-dismiss="modal">
                <span aria-hidden="true">√ó</span>
            </button>
        </header>
        
        <div class="modal__body">
            <form id="new-session-form" class="form">
                <div class="form-group">
                    <label for="session-title" class="form-label">Session Title (Optional):</label>
                    <input type="text" id="session-title" name="title" class="form-input" 
                           placeholder="Enter a title for your chat session">
                    <div class="form-help">
                        If left empty, a title will be generated based on your first message.
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn--primary">
                        <span class="btn__icon" aria-hidden="true">‚ú®</span>
                        Create Session
                    </button>
                    <button type="button" class="btn btn--secondary" data-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- API Key Warning Modal -->
<div id="api-key-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="api-key-title" aria-hidden="true">
    <div class="modal__overlay" aria-hidden="true"></div>
    <div class="modal__container">
        <header class="modal__header">
            <h2 id="api-key-title" class="modal__title">Anthropic API Key Required</h2>
        </header>
        
        <div class="modal__body">
            <div class="alert alert--warning">
                <p><strong>No Anthropic API Key Configured</strong></p>
                <p>To use the chat functionality, you need to configure your Anthropic API key.</p>
                
                <h3>How to set up your API key:</h3>
                <ol>
                    <li>Get your API key from <a href="https://console.anthropic.com/" target="_blank" rel="noopener">Anthropic Console</a></li>
                    <li>Set the environment variable: <code>ANTHROPIC_API_KEY=your_key_here</code></li>
                    <li>Restart the application</li>
                </ol>
                
                <p class="text-small">
                    <strong>Note:</strong> Your API key is only used to communicate with Anthropic's servers. It is never stored or transmitted elsewhere.
                </p>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn--primary" data-dismiss="modal">
                    I Understand
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chat JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const chatInterface = new MCPChatInterface();
    chatInterface.init();
});

class MCPChatInterface {
    constructor() {
        this.currentSessionId = null;
        this.sessions = new Map();
        this.connectedServers = new Map();
        this.selectedServerIds = new Set();
        this.isApiKeyConfigured = false;
    }
    
    init() {
        this.setupEventListeners();
        this.loadConnectedServers();
        this.loadChatSessions();
        this.checkApiKeyConfiguration();
    }
    
    setupEventListeners() {
        // New session button
        document.getElementById('new-session-btn')?.addEventListener('click', () => {
            this.showNewSessionModal();
        });
        
        // New session form
        document.getElementById('new-session-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.createNewSession();
        });
        
        // Chat form
        document.getElementById('chat-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.sendMessage();
        });
        
        // Message input
        const messageInput = document.getElementById('message-input');
        messageInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // Clear chat button
        document.getElementById('clear-chat-btn')?.addEventListener('click', () => {
            this.clearCurrentChat();
        });
        
        // Export chat button
        document.getElementById('export-chat-btn')?.addEventListener('click', () => {
            this.exportCurrentChat();
        });
        
        // Modal handling
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-dismiss="modal"]') || e.target.closest('[data-dismiss="modal"]')) {
                const modal = e.target.closest('.modal');
                this.closeModal(modal);
            }
        });
    }
    
    async checkApiKeyConfiguration() {
        try {
            // Try to create a session to test if API key is configured
            const response = await fetch('/api/chat/sessions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: 'Test Session' })
            });
            
            if (response.ok) {
                this.isApiKeyConfigured = true;
                // Delete the test session
                const session = await response.json();
                await fetch(`/api/chat/sessions/${session.id}`, { method: 'DELETE' });
            } else {
                const error = await response.json();
                if (error.error && error.error.includes('API key')) {
                    this.showApiKeyModal();
                    this.isApiKeyConfigured = false;
                }
            }
        } catch (error) {
            console.error('Error checking API key configuration:', error);
        }
    }
    
    showApiKeyModal() {
        const modal = document.getElementById('api-key-modal');
        this.showModal(modal);
    }
    
    async loadConnectedServers() {
        try {
            const response = await fetch('/api/servers');
            const servers = await response.json();
            
            const connectedServers = servers.filter(s => s.status === 'connected');
            this.updateServerSelection(connectedServers);
            
            connectedServers.forEach(server => {
                this.connectedServers.set(server.id, server);
            });
            
        } catch (error) {
            console.error('Failed to load connected servers:', error);
            this.announceError('Failed to load connected servers');
        }
    }
    
    updateServerSelection(servers) {
        const container = document.getElementById('server-checkboxes');
        if (!container) return;
        
        if (servers.length === 0) {
            container.innerHTML = `
                <div class="no-servers">
                    <p>No MCP servers connected.</p>
                    <a href="/connections" class="btn btn--small btn--secondary">
                        Connect Servers
                    </a>
                </div>
            `;
            return;
        }
        
        const checkboxesHtml = servers.map(server => `
            <label class="checkbox-label">
                <input type="checkbox" name="server" value="${server.id}" class="server-checkbox">
                <span class="checkbox-text">${server.name}</span>
            </label>
        `).join('');
        
        container.innerHTML = checkboxesHtml;
        
        // Add event listeners
        container.querySelectorAll('.server-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    this.selectedServerIds.add(e.target.value);
                } else {
                    this.selectedServerIds.delete(e.target.value);
                }
                this.updateChatInputState();
            });
        });
    }
    
    async loadChatSessions() {
        try {
            const response = await fetch('/api/chat/sessions');
            const sessions = await response.json();
            
            this.updateSessionsList(sessions);
            
        } catch (error) {
            console.error('Failed to load chat sessions:', error);
            this.announceError('Failed to load chat sessions');
        }
    }
    
    updateSessionsList(sessions) {
        const container = document.getElementById('sessions-list');
        if (!container) return;
        
        if (sessions.length === 0) {
            container.innerHTML = `
                <div class="empty-sessions">
                    <p>No chat sessions yet.</p>
                    <p class="text-small">Create your first chat session to get started.</p>
                </div>
            `;
            return;
        }
        
        const sessionsHtml = sessions.map(session => `
            <div class="session-item" role="listitem" data-session-id="${session.id}">
                <button type="button" class="session-button" onclick="chatInterface.selectSession('${session.id}')">
                    <div class="session-info">
                        <h3 class="session-title">${session.title}</h3>
                        <div class="session-meta">
                            <span class="message-count">${session.message_count} messages</span>
                            <time class="session-date">${new Date(session.updated_at).toLocaleDateString()}</time>
                        </div>
                    </div>
                </button>
                <button type="button" class="session-delete" onclick="chatInterface.deleteSession('${session.id}')" 
                        aria-label="Delete session: ${session.title}">
                    <span aria-hidden="true">üóëÔ∏è</span>
                </button>
            </div>
        `).join('');
        
        container.innerHTML = sessionsHtml;
        
        // Store sessions
        sessions.forEach(session => {
            this.sessions.set(session.id, session);
        });
    }
    
    showNewSessionModal() {
        if (!this.isApiKeyConfigured) {
            this.showApiKeyModal();
            return;
        }
        
        const modal = document.getElementById('new-session-modal');
        this.showModal(modal);
    }
    
    async createNewSession() {
        try {
            const form = document.getElementById('new-session-form');
            const formData = new FormData(form);
            const title = formData.get('title') || undefined;
            
            const response = await fetch('/api/chat/sessions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title })
            });
            
            if (response.ok) {
                const session = await response.json();
                this.sessions.set(session.id, session);
                this.loadChatSessions(); // Refresh the list
                this.selectSession(session.id);
                this.closeModal(document.getElementById('new-session-modal'));
                form.reset();
                this.announceToScreenReader('New chat session created');
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to create session');
            }
            
        } catch (error) {
            console.error('Error creating session:', error);
            this.announceError(`Failed to create session: ${error.message}`);
        }
    }
    
    async selectSession(sessionId) {
        try {
            const response = await fetch(`/api/chat/sessions/${sessionId}`);
            if (!response.ok) {
                throw new Error('Session not found');
            }
            
            const session = await response.json();
            this.currentSessionId = sessionId;
            this.sessions.set(sessionId, session);
            
            // Update UI
            this.updateChatTitle(session.title);
            this.displayMessages(session.messages);
            this.updateSelectedSession(sessionId);
            this.updateChatInputState();
            
            this.announceToScreenReader(`Selected chat session: ${session.title}`);
            
        } catch (error) {
            console.error('Error selecting session:', error);
            this.announceError('Failed to load chat session');
        }
    }
    
    updateChatTitle(title) {
        const titleElement = document.getElementById('current-session-title');
        if (titleElement) {
            titleElement.textContent = title;
        }
    }
    
    displayMessages(messages) {
        const container = document.getElementById('chat-messages');
        if (!container) return;
        
        if (!messages || messages.length === 0) {
            container.innerHTML = `
                <div class="chat-empty">
                    <p>Start the conversation by sending a message below.</p>
                </div>
            `;
            return;
        }
        
        const messagesHtml = messages.map(message => this.renderMessage(message)).join('');
        container.innerHTML = messagesHtml;
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }
    
    renderMessage(message) {
        const timestamp = new Date(message.timestamp).toLocaleString();
        const roleClass = `message--${message.role}`;
        
        let toolCallsHtml = '';
        if (message.tool_calls && message.tool_calls.length > 0) {
            toolCallsHtml = `
                <div class="message-tools">
                    <h4>Tools Used:</h4>
                    <ul>
                        ${message.tool_calls.map(call => `
                            <li>
                                <strong>${call.name}</strong>
                                ${call.input ? `<pre><code>${JSON.stringify(call.input, null, 2)}</code></pre>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
        
        return `
            <div class="message ${roleClass}" role="article">
                <div class="message-header">
                    <span class="message-role">${message.role}</span>
                    <time class="message-time">${timestamp}</time>
                </div>
                <div class="message-content">
                    <div class="message-text">${this.formatMessageContent(message.content)}</div>
                    ${toolCallsHtml}
                </div>
            </div>
        `;
    }
    
    formatMessageContent(content) {
        // Simple formatting - convert line breaks and code blocks
        return content
            .replace(/\n/g, '<br>')
            .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
            .replace(/`([^`]+)`/g, '<code>$1</code>');
    }
    
    updateSelectedSession(sessionId) {
        // Update visual selection in sessions list
        document.querySelectorAll('.session-item').forEach(item => {
            item.classList.remove('session-item--selected');
        });
        
        const selectedItem = document.querySelector(`[data-session-id="${sessionId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('session-item--selected');
        }
    }
    
    updateChatInputState() {
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-chat-btn');
        const exportBtn = document.getElementById('export-chat-btn');
        
        const canChat = this.currentSessionId && this.isApiKeyConfigured;
        
        if (messageInput) messageInput.disabled = !canChat;
        if (sendBtn) sendBtn.disabled = !canChat;
        if (clearBtn) clearBtn.disabled = !this.currentSessionId;
        if (exportBtn) exportBtn.disabled = !this.currentSessionId;
    }
    
    async sendMessage() {
        if (!this.currentSessionId || !this.isApiKeyConfigured) {
            return;
        }
        
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        
        if (!message) {
            return;
        }
        
        try {
            // Disable input while sending
            this.setInputLoading(true);
            
            // Add user message to UI immediately
            this.addMessageToUI({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            // Clear input
            messageInput.value = '';
            
            // Send message to server
            const response = await fetch(`/api/chat/sessions/${this.currentSessionId}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    server_ids: Array.from(this.selectedServerIds)
                })
            });
            
            if (response.ok) {
                const assistantMessage = await response.json();
                this.addMessageToUI(assistantMessage);
                this.announceToScreenReader('Message sent and response received');
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to send message');
            }
            
        } catch (error) {
            console.error('Error sending message:', error);
            this.announceError(`Failed to send message: ${error.message}`);
        } finally {
            this.setInputLoading(false);
        }
    }
    
    addMessageToUI(message) {
        const container = document.getElementById('chat-messages');
        if (!container) return;
        
        // Remove empty state if present
        const emptyState = container.querySelector('.chat-empty, .chat-welcome');
        if (emptyState) {
            emptyState.remove();
        }
        
        // Add message
        const messageHtml = this.renderMessage(message);
        container.insertAdjacentHTML('beforeend', messageHtml);
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }
    
    setInputLoading(loading) {
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        if (loading) {
            if (messageInput) messageInput.disabled = true;
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="btn__icon" aria-hidden="true">‚è≥</span>Sending...';
            }
            if (stopBtn) stopBtn.style.display = 'inline-flex';
        } else {
            if (messageInput) messageInput.disabled = false;
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span class="btn__icon" aria-hidden="true">üöÄ</span>Send Message';
            }
            if (stopBtn) stopBtn.style.display = 'none';
        }
    }
    
    async deleteSession(sessionId) {
        if (!confirm('Are you sure you want to delete this chat session?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/chat/sessions/${sessionId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                this.sessions.delete(sessionId);
                
                if (this.currentSessionId === sessionId) {
                    this.currentSessionId = null;
                    this.updateChatTitle('Select or create a chat session');
                    this.displayMessages([]);
                    this.updateChatInputState();
                }
                
                this.loadChatSessions();
                this.announceToScreenReader('Chat session deleted');
            } else {
                throw new Error('Failed to delete session');
            }
            
        } catch (error) {
            console.error('Error deleting session:', error);
            this.announceError('Failed to delete session');
        }
    }
    
    clearCurrentChat() {
        if (!this.currentSessionId) return;
        
        if (!confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
            return;
        }
        
        // For now, we'll delete and recreate the session
        // In a more advanced implementation, we'd have a clear endpoint
        this.deleteSession(this.currentSessionId);
    }
    
    exportCurrentChat() {
        if (!this.currentSessionId) return;
        
        const session = this.sessions.get(this.currentSessionId);
        if (!session) return;
        
        const exportData = {
            title: session.title,
            created_at: session.created_at,
            messages: session.messages,
            active_servers: session.active_server_ids
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat-${session.title.replace(/[^a-zA-Z0-9]/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.announceToScreenReader('Chat exported successfully');
    }
    
    showModal(modal) {
        if (!modal) return;
        
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
        
        // Focus first focusable element
        const focusable = modal.querySelector('input, textarea, select, button:not([data-dismiss="modal"])');
        if (focusable) {
            setTimeout(() => focusable.focus(), 100);
        }
    }
    
    closeModal(modal) {
        if (!modal) return;
        
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
    }
    
    announceToScreenReader(message) {
        const announcer = document.getElementById('status-announcements');
        if (announcer) {
            announcer.textContent = message;
        }
    }
    
    announceError(message) {
        const announcer = document.getElementById('error-announcements');
        if (announcer) {
            announcer.textContent = message;
        }
    }
}

// Make chat interface globally available
window.chatInterface = null;
</script>
{% endblock %}